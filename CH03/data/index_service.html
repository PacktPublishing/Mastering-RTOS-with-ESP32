<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GDU Service</title>
    <style>
      body {
        margin: 0;
      }

      span {
        display: inline-block;
        width: 80px;
      }

      .label {
        color: white;
        padding: 3px 6px;
        border-radius: 3px;
        margin-left: 10px;
      }

      .success {
        background-color: #04aa6d;
      }

      .info {
        background-color: #2196f3;
      }

      .warning {
        background-color: #ff9800;
      }

      .danger {
        background-color: #cf211598;
      }

      .other {
        background-color: #e7e7e7;
        color: black;
      }

      .active-link,
      button:hover,
      a:hover {
        background-color: rgb(99, 94, 155);
      }

      select,
      input {
        margin-left: 10px;
        padding: 3px 5px;
        border: 0;
        border-radius: 6px;
        box-shadow: 0 0 5px 2px rgba(0, 0, 0, 0.06);
      }

      link {
        padding: 3px 5px;
        font-size: larger;
        border-radius: 5px;
      }

      button:disabled {
        color: black;
        background-color: rgb(191, 193, 194);
      }

      button {
        color: #fff;
        text-align: center;
        text-decoration: none;
        padding: 3px 5px;
        font-size: medium;
        border-radius: 5px;
        background-color: rgb(43, 53, 60);
      }

      .item {
        padding: 12px 15px;
      }

      .container {
        display: none;
        flex-wrap: wrap;
        justify-content: space-between;
        width: 100%;
      }

      .active {
        display: flex;
      }

      .heading {
        text-transform: uppercase;
        text-align: start;
        color: white;
        padding: 6px 10px;
        background-color: rgba(56, 62, 66, 0.808);
      }

      .table-cell {
        width: fit-content;
        padding: 6px 10px;
        background-color: rgb(191, 193, 194);
      }

      .table-container {
        width: 90%;
        margin-top: 15px;
        margin-left: auto;
        margin-right: auto;
        border-collapse: collapse;
        font-size: medium;
      }

      tr.border-bottom td {
        border-bottom: 2pt solid rgb(99, 94, 155);
      }

      tr.border-bottom-light td {
        border-bottom: 1pt solid rgb(211, 209, 233);
      }

      .navbar {
        background-color: rgb(43, 53, 60);
        color: white;
        width: 100%;
        align-items: center;
        display: flex;
      }

      .logo {
        padding-left: 20px;
        text-align: start;
        flex: 1;
        font-size: 28px;
      }

      .menu {
        padding-right: 8px;
        padding-top: 12px;
        padding-bottom: 10px;
        text-align: end;
        font-size: 16px;
      }

      /* media query for small screens */
      @media only screen and (max-width: 700px) {
        .navbar {
          width: 100%;
          flex-direction: column;
          justify-content: center;
        }

        .logo {
          padding-left: 0px;
          text-align: center;
          flex: 1;
          font-size: 24px;
        }

        .menu {
          padding: 6px;
          padding-bottom: 10px;
          text-align: center;
          font-size: 14px;
        }

        .table-container {
          width: 100%;
          margin-top: 5px;
          border-collapse: collapse;
          font-size: small;
        }
      }
    </style>
    <script>
      var startTime; // will hold the timestamp when the timer starts or resumes
      var elapsedTime = 0; // will hold the elapsed time in milliseconds
      var timerInterval; // will hold the setInterval ID for the timer
      var isRunning = false; // will hold the current state of the stopwatch

      function openStopWatch() {
        var popup = document.getElementById("idStopWatch");
        popup.style.display = "flex";
      }

      function closeStopWatch() {
        var popup = document.getElementById("idStopWatch");
        popup.style.display = "none";
      }

      function startStop() {
        var button = document.getElementById("startStopButton"); // get the start/stop button
        var resetButton = document.getElementById("resetButton"); // get the reset button
        if (!isRunning) {
          // if the stopwatch is not running, start it
          startTime = Date.now() - elapsedTime; // set the start time to now minus elapsed time
          timerInterval = setInterval(updateTimer, 10); // start the timer interval
          button.textContent = "Stop"; // change the button text to "Stop"
          resetButton.disabled = false; // enable the reset button
          isRunning = true; // set the stopwatch state to running
        } else {
          // if the stopwatch is running, stop it
          clearInterval(timerInterval); // stop the timer interval
          button.textContent = "Start"; // change the button text to "Start"
          isRunning = false; // set the stopwatch state to not running
        }
      }

      function updateTimer() {
        var currentTime = Date.now(); // get the current timestamp
        elapsedTime = currentTime - startTime; // calculate the elapsed time
        var minutes = Math.floor(elapsedTime / 60000); // convert milliseconds to minutes
        var seconds = Math.floor((elapsedTime % 60000) / 1000); // convert milliseconds to seconds
        var milliseconds = Math.floor((elapsedTime % 1000) / 10); // convert milliseconds to hundredths of a second
        var timer = document.getElementById("timer"); // get the timer element
        timer.textContent =
          ("0" + minutes).slice(-2) +
          ":" +
          ("0" + seconds).slice(-2) +
          ":" +
          ("0" + milliseconds).slice(-2); // update the timer text content
      }

      function reset() {
        clearInterval(timerInterval); // stop the timer interval
        elapsedTime = 0; // reset the elapsed time to zero
        isRunning = false; // set the stopwatch state to not running
        document.getElementById("timer").textContent = "00:00:00"; // reset the timer display
        document.getElementById("startStopButton").textContent = "Start"; // set the start/stop button text to "Start"
        document.getElementById("resetButton").disabled = true; // disable the reset button
      }
    </script>
  </head>

  <body onload="get_data()">
    <!-- Navbar  -->
    <div class="navbar">
      <div class="logo">Greyter Water System</div>
      <div class="menu">
        <a
          style="padding: 3px 5px; font-size: larger; border-radius: 5px"
          class="active-link"
          onclick="showContainer(1)"
          >Home</a
        >
        <a
          style="padding: 3px 5px; font-size: larger; border-radius: 5px"
          onclick="showContainer(2)"
          >Manual</a
        >
        <a
          style="padding: 3px 5px; font-size: larger; border-radius: 5px"
          onclick="showContainer(3)"
          >Registration</a
        >
        <a
          style="padding: 3px 5px; font-size: larger; border-radius: 5px"
          onclick="showContainer(4)"
          >Settings</a
        >
        <a
          style="padding: 3px 5px; font-size: larger; border-radius: 5px"
          onclick="showContainer(5)"
          >Update</a
        >
        <a
          style="padding: 3px 5px; font-size: larger; border-radius: 5px"
          onclick="showContainer(6)"
          >System</a
        >
        <a
          style="padding: 3px 5px; font-size: larger; border-radius: 5px"
          onclick="openStopWatch()"
          >Watch</a
        >
      </div>
    </div>
    <!-- StopWatch Bar -->
    <div
      id="idStopWatch"
      style="
        background-color: skyblue;
        display: none;
        color: white;
        width: 100%;
        align-items: center;
      ">
      <div class="item right" style="flex: 1"></div>
      <div class="item right">
        <button id="timer" style="font-size: x-large; color: white" disabled>
          00:00:00
        </button>
      </div>
      <div class="item right">
        <button id="startStopButton" onclick="startStop()">Start</button>
        <button id="resetButton" onclick="reset()" disabled>Reset</button>
        <button onclick="closeStopWatch()">Close</button>
      </div>
    </div>
    <!-- Home  -->
    <div
      id="container1"
      class="container active"
      style="flex-direction: column">
      <div class="table-container">
        <button
          style="font-size: small"
          id="gotoUserBtn"
          onclick="gotoUserPages()">
          Goto Customer local dash!
        </button>
      </div>
      <div class="table-container">
        <table id="homeControlsTable" style="width: fit-content">
          <tr>
            <th colspan="3" style="text-align: start">GDU Controls</th>
          </tr>
          <tr style="text-align: start">
            <td>
              <button
                style="font-size: small"
                id="ctrlButton1"
                onclick="controlButtonClick(1)">
                Restart
              </button>
            </td>
          </tr>
        </table>
      </div>
      <table id="tableHomeService" class="table-container">
        <tr>
          <th>Home: Fetching information, click again if stale</th>
        </tr>
      </table>
    </div>
    <!-- Manual  -->
    <div id="container2" class="container" style="flex-direction: column">
      <table id="tableManual" class="table-container">
        <tr>
          <th>Manual: Fetching information, click again if stale</th>
        </tr>
      </table>
    </div>
    <!-- Registration  -->
    <div id="container3" class="container" style="flex-direction: column">
      <div class="table-container">
        <table id="homeControlsTable" style="width: fit-content">
          <tr style="text-align: start">
            <td>
              <button
                style="font-size: small"
                id="ctrlButton3"
                onclick="controlButtonClick(3)">
                Register/Update
              </button>
            </td>
          </tr>
        </table>
      </div>
      <table id="tableRegistration" class="table-container">
        <tr>
          <th>Registration: Fetching information, click again if stale</th>
        </tr>
      </table>
    </div>
    <!-- Settings  -->
    <div id="container4" class="container" style="flex-direction: column">
      <table id="tableSettings" class="table-container">
        <tr>
          <th>Settings: Fetching information, click again if stale</th>
        </tr>
      </table>
    </div>
    <!-- Update  -->
    <div id="container5" class="container" style="flex-direction: column">
      <table id="tableUpdate" class="table-container">
        <tr>
          <th>Update: Fetching information, click again if stale</th>
        </tr>
      </table>
      <div class="table-container">
        <table id="otaTable">
          <tr>
            <th style="font-size: large; text-align: start">
              Update GDU Firmware
            </th>
          </tr>
          <tr class="border-bottom-light">
            <td class="table-cell">
              <input id="ota-file-input" type="file" name="gdu_firmware_file" />
              <button
                id="ota-update-button"
                style="margin: 10px"
                onclick="update_ota_submitted()"
                disabled>
                Update
              </button>
            </td>
          </tr>
          <tr>
            <td>
              <progress
                id="progress-bar"
                style="width: 100%; height: 45px"
                max="100"
                value="0"
                hidden></progress>
            </td>
          </tr>
          <tr>
            <td>
              <span id="progress" style="width: 100%"></span>
            </td>
          </tr>
        </table>
      </div>
    </div>
    <!-- System  -->
    <div id="container6" class="container" style="flex-direction: column">
      <table id="tableSystem" class="table-container">
        <tr>
          <th>System: Fetching information, click again if stale</th>
        </tr>
      </table>
    </div>
    <!-- Footer -->
    <div
      style="
        background-color: rgb(97, 106, 112);
        width: 100%;
        margin-top: 80px;
      ">
      <p
        style="
          color: white;
          font-size: medium;
          text-align: center;
          padding: 10px;
        ">
        @greyter.com All Rights Reserved
      </p>
    </div>

    <script>
      /* Data Requester and Sender */
      var xmlHttp = createXmlHttpObject();
      var update_process_enable = true;
      var update_process_active = false;
      var current_containerNum = 1; // home
      var myTimeout = 0;
      get_data_names = [
        "HomeService",
        "Manual",
        "Registration",
        "Settings",
        "Update",
        "System",
      ];
      exTypesArr = ["text", "number", "email", "password", "tel"];

      const fileInput = document.getElementById("ota-file-input");
      const updateButton = document.getElementById("ota-update-button");

      // Add an event listener to the file input field to check when a file has been selected
      fileInput.addEventListener("change", function () {
        // Check if a file has been selected
        if (fileInput.files.length > 0) {
          // Enable the update button
          updateButton.disabled = false;
        } else {
          // Disable the update button
          updateButton.disabled = true;
        }
      });

      /* Fetch and Display Data */
      function get_data() {
        if (myTimeout) {
          clearTimeout(myTimeout);
        }
        _get_data_request(get_data_names[current_containerNum - 1]);
        myTimeout = setTimeout("get_data()", 6000);
      }
      function _get_data_request(name) {
        if (update_process_enable) {
          const data = `name=${name}`;
          if (xmlHttp.readyState == 0 || xmlHttp.readyState == 4) {
            xmlHttp.open("POST", `getData`, true);
            xmlHttp.setRequestHeader(
              "Content-Type",
              "application/x-www-form-urlencoded"
            );
            xmlHttp.onreadystatechange = function () {
              if (this.readyState == 4 && this.status == 200) {
                if (xmlHttp.responseXML) {
                  // console.log("Data: ", xmlHttp);
                  console.log("Data: rxd");
                  populate_table(
                    xmlHttp.responseXML.all,
                    name,
                    `table${name}`,
                    "postData"
                  );
                }
              }
            };
            xmlHttp.send(data);
            console.log("Requesting", data);
          }
        } else {
          console.log("Data fetching disabled");
        }
      }
      function send_data(id, value, address) {
        const data = `id=${id}&value=${value}`;
        if (xmlHttp.readyState == 0 || xmlHttp.readyState == 4) {
          xmlHttp.open("POST", address, true);
          xmlHttp.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
          );
          xmlHttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
              console.log(this.responseText);
              if (update_process_active == false) {
                update_process_enable = true;
                get_data();
              }
            }
          };
          xmlHttp.send(data);
          update_process_active = false;
          console.log("Sending data: " + data);
        }
      }
      function checkInput(event) {
        let click_id = event.target.getAttribute("id");
        const input = document.getElementById(click_id);
        send_data(click_id, input.value, input.name);
      }
      function disableUpdates() {
        update_process_enable = false;
        update_process_active = true;
        console.log("disabled");
      }
      const indexEnum = {
        id: 0,
        valid: 1,
        delta: 2,
        r_w: 3,
        store: 4,
        maxLen: 5,
        len: 6,
        ex_typ: 7,
        data: 8,
        type: 9,
      };
      function populate_table(x, title, tableName, post_address) {
        var txt = "";
        // console.log("Data: ", x, "length: ", x.length);
        console.log(title, tableName, post_address);
        txt += `<tr>`;
        txt += `<th style="font-size: large; color: white; text-align: start; background-color: rgb(43, 53, 60); padding: 7px;" colspan="3">${title}</th>`;
        txt += `</tr>`;
        for (i = 1; i < x.length; i++) {
          valueArr = [];
          name = x[i].nodeName.replace(/_/g, "  ");
          val = x[i].innerHTML;
          option_cell = "";
          if (val.indexOf(",") > -1) {
            valueArr = val.split(",");
            // console.log(valueArr);

            _isValid = valueArr[indexEnum.valid];
            _idV = valueArr[indexEnum.id];
            _erorr = valueArr[indexEnum.error];
            _namV = post_address;
            _valV = valueArr[indexEnum.data];
            _fncV = "checkInput(event);";
            _exTyp = "text";
            _readOnly = "";
            _minV = 0;
            _maxV = parseInt(valueArr[indexEnum.maxLen]);

            if (
              valueArr[indexEnum.r_w] === "0" ||
              valueArr[indexEnum.r_w] === "2"
            ) {
              _readOnly = "readonly";
            }

            if (valueArr[indexEnum.ex_typ] < exTypesArr.length) {
              _exTyp = exTypesArr[valueArr[indexEnum.ex_typ]];
            }

            if (valueArr[indexEnum.type] === "UINT8") {
              _minV = 0;
              _maxV = 255;
            } else if (valueArr[indexEnum.type] === "INT8") {
              _minV = -128;
              _maxV = 127;
            } else if (valueArr[indexEnum.type] === "UINT16") {
              _minV = 0;
              _maxV = 65535;
            } else if (valueArr[indexEnum.type] === "INT16") {
              _minV = -32768;
              _maxV = 32767;
            } else if (valueArr[indexEnum.type] === "UINT32") {
              _minV = 0;
              _maxV = 4294967295;
            } else if (valueArr[indexEnum.type] === "INT32") {
              _minV = -2147483648;
              _maxV = 2147483647;
            } else {
              _minV = 0;
              _maxV = 0;
            }

            // console.log(_idV, _namV, _valV, _fncV, _exTyp, _minV, _maxV);
            console.log(
              "ID: " +
                _idV +
                " Name: " +
                _namV +
                " Value: " +
                _valV +
                " Error: " +
                _erorr +
                " ExType: " +
                _exTyp +
                " ReadOnly: " +
                _readOnly +
                " Min: " +
                _minV +
                " Max: " +
                _maxV
            );

            option_cell = `<td class="table-cell">`;
            if (_erorr == "1") {
              option_cell += `<span class="label danger">Error</span>`;
            }

            if (_readOnly === "readonly") {
              if (_isValid == "1") {
                option_cell += `<input style="background-color: LightGray" type=${_exTyp} id=${_idV} name=${_namV} ${_readOnly} min=${_minV} max=${_maxV} value="${_valV}">`;
              } else {
                option_cell += `<input style="background-color: LightGray" type=${_exTyp} id=${_idV} name=${_namV} ${_readOnly} min=${_minV} max=${_maxV}>`;
              }
            } else {
              if (
                valueArr[indexEnum.type] === "ENUM_MANUAL" ||
                valueArr[indexEnum.type] === "TRUE_FALSE" ||
                valueArr[indexEnum.type] === "OFF_ON" ||
                valueArr[indexEnum.type] === "YES_NO"
              ) {
                option_cell += `<span class="label other">${_valV}</span>`;
                option_cell += `<select id=${_idV} name=${_namV} onfocus="disableUpdates()" onchange=${_fncV}>`;
                let value_enum = 0;
                for (
                  let index = indexEnum.type + 1;
                  index < valueArr.length;
                  index++
                ) {
                  const element = valueArr[index];
                  if (element === _valV) {
                    option_cell += `<option value=${value_enum} selected>${element}</option>`;
                  } else {
                    option_cell += `<option value=${value_enum}>${element}</option>`;
                  }
                  value_enum = value_enum + 1;
                }
                option_cell += `</select>`;
              } else {
                if (_isValid == "1") {
                  option_cell += `<input type=${_exTyp} id=${_idV} name=${_namV} onfocus="disableUpdates()" onchange=${_fncV} min=${_minV} max=${_maxV} value="${_valV}">`;
                } else {
                  option_cell += `<input type=${_exTyp} id=${_idV} name=${_namV} onfocus="disableUpdates()" onchange=${_fncV} min=${_minV} max=${_maxV}>`;
                }
              }
            }
            option_cell += `</td>`;
            // console.log("Cell: " + option_cell);
            // console.log("------------------------------------------------");
          }
          txt += `<tr class="border-bottom-light">`;
          txt += `<td class="heading">${name}</td>`;
          txt += `<td width="7px" class="heading">:</td>`;
          txt += option_cell;
          txt += `</tr>`;
        }
        if (txt) {
          document.getElementById(`${tableName}`).innerHTML = txt;
        }
        // console.log("------------------------------------------------\n\n");
      }

      /* Control Requester */
      function gotoUserPages() {
        document.getElementById("gotoUserBtn").disabled = true;
        window.open("/user", "_blank");
      }

      function enableControlButton() {
        document.getElementById("ctrlButton1").disabled = false;
        document.getElementById("ctrlButton3").disabled = false;
      }

      function controlButtonClick(id) {
        const data = `controls=${1}&id=${id}`;
        document.getElementById("ctrlButton1").disabled = true;
        document.getElementById("ctrlButton3").disabled = true;
        if (xmlHttp.readyState == 0 || xmlHttp.readyState == 4) {
          xmlHttp.open("POST", "postControls", true);
          xmlHttp.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
          );

          xmlHttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
              console.log(this.responseText);
              setTimeout("enableControlButton()", 5000);
            }
          };
          xmlHttp.send(data);
        }
      }

      /* Update OTA */
      function update_ota_submitted() {
        updateButton.disabled = true;
        const file = document.getElementById("ota-file-input").files[0];
        update_process_enable = false;
        if (xmlHttp.readyState == 0 || xmlHttp.readyState == 4) {
          xmlHttp.upload.addEventListener("progress", e => {
            if (e.lengthComputable) {
              const percent = (e.loaded / e.total) * 100;
              document.getElementById("progress-bar").value =
                percent.toFixed(2);
              document.getElementById("progress-bar").hidden = false;
            }
          });

          xmlHttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
              document.getElementById("progress").innerHTML =
                xmlHttp.responseText;
              setTimeout(() => {
                location.reload();
              }, 10000); // Reload the page after 5 seconds
            }
          };
          xmlHttp.open("POST", "/update");
          const formData = new FormData();
          formData.append("firmware", file);
          xmlHttp.send(formData);
          document.getElementById("progress").innerHTML = "Updating...";
        }
      }

      function showContainer(containerNum) {
        // hide all containers
        var containers = document.getElementsByClassName("container");
        for (var i = 0; i < containers.length; i++) {
          containers[i].classList.remove("active");
        }

        // show the selected container
        var container = document.getElementById("container" + containerNum);
        container.classList.add("active");

        // set active link in navbar
        var links = document.getElementsByTagName("a");
        for (var i = 0; i < links.length; i++) {
          links[i].classList.remove("active-link");
        }
        var link = document.getElementsByTagName("a")[containerNum - 1];
        link.classList.add("active-link");

        current_containerNum = containerNum;
        if (!update_process_enable) update_process_enable = true;
        get_data();
      }
      function createXmlHttpObject() {
        if (window.XMLHttpRequest) {
          xmlHttp = new XMLHttpRequest();
        } else {
          xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        return xmlHttp;
      }
    </script>
  </body>
</html>
